<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amaia - AI Pop Idol Fan Experience</title>
  <style>
    body { background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .container { text-align: center; max-width: 400px; padding: 20px; }
    .avatar { width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #a855f7); box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); margin: 0 auto 20px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    button { background: #ec4899; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px; }
    button:hover { background: #db2777; }
    .status { margin: 20px 0; font-size: 18px; }
    .transcript { background: #2a2a2a; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Amaia Voss</h1>
    <div id="call-screen">
      <div class="avatar"></div>
      <p>Incoming call from Amaia...</p>
      <button id="answer-btn">Answer</button>
    </div>
    <div id="chat-screen" class="hidden">
      <div class="avatar"></div>
      <div class="status" id="status">Amaia is online</div>
      <button id="mic-btn">ðŸŽ¤ Speak</button>
      <button id="hangup-btn">Hang Up</button>
      <div class="transcript" id="transcript"></div>
      <button id="mute-btn">Mute</button>
    </div>
    <div id="setup-modal" class="hidden">
      <p>Enter ElevenLabs API Key:</p>
      <input type="text" id="api-key-input">
      <button id="save-key-btn">Save</button>
    </div>
  </div>

  <script type="text/babel">
    const CallApp = () => {
      const [isCallActive, setIsCallActive] = React.useState(false);
      const [isConnected, setIsConnected] = React.useState(false);
      const [status, setStatus] = React.useState('Amaia is online');
      const [transcript, setTranscript] = React.useState([]);
      const [isMuted, setIsMuted] = React.useState(false);
      const [showModal, setShowModal] = React.useState(!localStorage.getItem('elevenLabsKey'));
      const websocketRef = React.useRef(null);
      const mediaRecorderRef = React.useRef(null);
      const audioContext = React.useRef(new AudioContext());
      const audioQueue = React.useRef([]);
      const isPlaying = React.useRef(false);

      const addToTranscript = (speaker, text) => {
        setTranscript(prev => [...prev, `${speaker}: ${text}`]);
      };

      const playAudioQueue = () => {
        if (isPlaying.current || audioQueue.current.length === 0) return;
        isPlaying.current = true;
        const chunk = audioQueue.current.shift();
        audioContext.current.decodeAudioData(chunk, (buffer) => {
          const source = audioContext.current.createBufferSource();
          source.buffer = buffer;
          source.connect(audioContext.current.destination);
          source.start();
          source.onended = () => {
            isPlaying.current = false;
            playAudioQueue();
          };
        }, (err) => {
          console.error('Audio decode error:', err);
          isPlaying.current = false;
          playAudioQueue();
        });
      };

      const getSignedUrl = async () => {
        try {
          const response = await fetch('/.netlify/functions/agent?get-signed-url', { method: 'GET' });
          if (!response.ok) throw new Error('Failed to get signed URL');
          const data = await response.json();
          return data.signed_url;
        } catch (error) {
          console.error('Signed URL error:', error);
          setStatus('Error getting signed URL');
          return null;
        }
      };

      const startConversation = async () => {
        setIsCallActive(true);
        setStatus('Connecting...');

        const signedUrl = await getSignedUrl();
        if (!signedUrl) return;

        console.log('Connecting to:', signedUrl);
        websocketRef.current = new WebSocket(signedUrl);

        websocketRef.current.onopen = () => {
          setIsConnected(true);
          setStatus('Connected! Say something...');
          console.log('WebSocket connected');
          // Send initiation data if needed
          websocketRef.current.send(JSON.stringify({ type: 'conversation_initiation_client_data' }));
        };

        websocketRef.current.onmessage = (event) => {
          if (typeof event.data === 'string') {
            try {
              const data = JSON.parse(event.data);
              console.log('Received JSON:', data);
              if (data.type === 'agent_text') {
                addToTranscript('Amaia', data.text || 'Thinking...');
              } else if (data.type === 'transcript') {
                addToTranscript('You', data.text);
              }
            } catch (err) {
              console.log('Received text:', event.data);
            }
          } else if (event.data instanceof Blob) {
            event.data.arrayBuffer().then((buffer) => {
              audioQueue.current.push(buffer);
              playAudioQueue();
            }).catch(err => console.error('Audio buffer error:', err));
          }
        };

        websocketRef.current.onerror = (err) => {
          console.error('WebSocket error:', err);
          setStatus('Connection error');
        };

        websocketRef.current.onclose = () => {
          setIsConnected(false);
          setStatus('Disconnected');
          console.log('WebSocket closed');
        };
      };

      const startRecording = async () => {
        if (!isConnected || isMuted) return;
        setStatus('Listening...');

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
          mediaRecorderRef.current.ondataavailable = (event) => {
            if (event.data.size > 0 && websocketRef.current.readyState === WebSocket.OPEN) {
              websocketRef.current.send(event.data);
            }
          };
          mediaRecorderRef.current.start(250); // Send chunks every 250ms
        } catch (err) {
          console.error('Mic error:', err);
          setStatus('Microphone permission denied');
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
          mediaRecorderRef.current.stop();
          mediaRecorderRef.current = null;
        }
        setStatus('Amaia is responding...');
      };

      const hangUp = () => {
        if (websocketRef.current) websocketRef.current.close();
        setIsCallActive(false);
        setTranscript([]);
      };

      const saveApiKey = () => {
        const key = document.getElementById('api-key-input').value;
        localStorage.setItem('elevenLabsKey', key);
        setShowModal(false);
      };

      React.useEffect(() => {
        return () => {
          if (websocketRef.current) websocketRef.current.close();
        };
      }, []);

      return (
        <div>
          <div id="call-screen" style={{ display: isCallActive ? 'none' : 'block' }}>
            <button onClick={startConversation}>Answer</button>
          </div>
          <div id="chat-screen" style={{ display: isCallActive ? 'block' : 'none' }}>
            <div className="status">{status}</div>
            <button onClick={startRecording}>ðŸŽ¤ Speak</button>
            <button onClick={hangUp}>Hang Up</button>
            <div className="transcript">
              {transcript.map((msg, i) => <p key={i}>{msg}</p>)}
            </div>
            <button onClick={() => setIsMuted(!isMuted)}>{isMuted ? 'Unmute' : 'Mute'}</button>
          </div>
          <div id="setup-modal" style={{ display: showModal ? 'block' : 'none' }}>
            <input id="api-key-input" type="text" />
            <button onClick={saveApiKey}>Save</button>
          </div>
        </div>
      );
    };

    ReactDOM.render(<CallApp />, document.querySelector('.container'));
  </script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</body>
</html>
