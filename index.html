<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amaia - AI Voice Chat</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé§</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <audio id="audio-player" style="display: none;"></audio>
    <audio id="fallback-player" controls style="margin: 16px auto; display: none;"></audio>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function AmaiaPlatform() {
            const [currentPage, setCurrentPage] = useState('intro');
            const [isOnCall, setIsOnCall] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [isThinking, setIsThinking] = useState(false);
            const [muted, setMuted] = useState(false);
            const [callTranscript, setCallTranscript] = useState([]);
            const [error, setError] = useState(null);
            const [audioAllowed, setAudioAllowed] = useState(false);
            const [lastAudioUrl, setLastAudioUrl] = useState(null);
            const recognitionRef = useRef(null);
            const audioRef = useRef(document.getElementById('audio-player'));
            const fallbackAudioRef = useRef(document.getElementById('fallback-player'));
            const audioContextRef = useRef(null);

            // Initialize audio context
            useEffect(() => {
                const unlockAudio = () => {
                    if (!audioContextRef.current) {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    audioContextRef.current.resume().then(() => {
                        console.log('Audio context resumed');
                        setAudioAllowed(true);
                    }).catch(e => {
                        console.error('Audio context resume error:', e);
                        setError('Audio playback blocked. Click anywhere to enable audio.');
                    });
                };
                document.addEventListener('click', unlockAudio);
                document.addEventListener('touchstart', unlockAudio);
                return () => {
                    document.removeEventListener('click', unlockAudio);
                    document.removeEventListener('touchstart', unlockAudio);
                };
            }, []);

            // Initialize speech recognition
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onstart = () => {
                        console.log('Speech recognition started');
                        setIsRecording(true);
                    };
                    recognitionRef.current.onend = () => {
                        console.log('Speech recognition ended');
                        setIsRecording(false);
                    };
                    recognitionRef.current.onresult = (event) => {
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                handleUserSpeech(event.results[i][0].transcript);
                            }
                        }
                    };
                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech error:', event.error);
                        setIsRecording(false);
                        setError('Microphone error: ' + event.error);
                    };
                } else {
                    console.error('Speech Recognition not supported');
                    setError('Speech Recognition not supported in this browser');
                }
            }, []);

            const playAudio = () => {
                console.log('Play Audio button clicked');
                if (!audioAllowed) {
                    console.log('Audio context not allowed yet');
                    setError('Audio playback blocked. Click anywhere to enable audio.');
                    return;
                }
                if (!lastAudioUrl) {
                    console.log('No audio URL available');
                    setError('No audio available to play.');
                    return;
                }
                if (muted) {
                    console.log('Audio muted');
                    setError('Audio is muted. Unmute to play.');
                    return;
                }

                console.log('Attempting manual audio playback:', lastAudioUrl.slice(0, 50) + '...');
                audioRef.current.src = lastAudioUrl;
                audioRef.current.play().then(() => {
                    console.log('Manual audio playback started (mpeg)');
                }).catch(e => {
                    console.error('Manual audio play error (mpeg):', e);
                    const mp3Url = lastAudioUrl.replace('audio/mpeg', 'audio/mp3');
                    audioRef.current.src = mp3Url;
                    audioRef.current.play().then(() => {
                        console.log('Manual audio playback started (mp3)');
                    }).catch(e => {
                        console.error('Manual audio play error (mp3):', e);
                        setError('Failed to play audio: ' + e.message);
                        fallbackAudioRef.current.style.display = 'block';
                        fallbackAudioRef.current.src = lastAudioUrl;
                    });
                });
            };

            const downloadAudio = () => {
                if (lastAudioUrl) {
                    console.log('Download audio clicked');
                    const link = document.createElement('a');
                    link.href = lastAudioUrl;
                    link.download = 'amaia_response.mp3';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const handleUserSpeech = async (transcript) => {
                if (!transcript.trim()) return;

                console.log('User speech transcribed:', transcript);

                const userMessage = {
                    id: Date.now(),
                    sender: 'user',
                    text: transcript,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                setCallTranscript(prev => {
                    console.log('Adding user transcript:', userMessage);
                    return [...prev, userMessage];
                });

                setIsThinking(true);
                setError(null);

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: transcript })
                    });

                    console.log('Response status:', response.status);
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status} - ${responseText}`);
                    }

                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        throw new Error('Invalid response format from server');
                    }

                    console.log('Backend response:', data);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.reply) {
                        const amaiaMessage = {
                            id: Date.now() + 1,
                            sender: 'amaia',
                            text: data.reply,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        };
                        setCallTranscript(prev => {
                            console.log('Adding Amaia transcript:', amaiaMessage);
                            return [...prev, amaiaMessage];
                        });

                        if (data.audioUrl) {
                            setLastAudioUrl(data.audioUrl);
                            if (!muted && audioAllowed) {
                                console.log('Attempting to auto-play audio:', data.audioUrl.slice(0, 50) + '...');
                                audioRef.current.src = data.audioUrl;
                                audioRef.current.play().then(() => {
                                    console.log('Auto-play started (mpeg)');
                                }).catch(e => {
                                    console.error('Auto audio play error (mpeg):', e);
                                    const mp3Url = data.audioUrl.replace('audio/mpeg', 'audio/mp3');
                                    audioRef.current.src = mp3Url;
                                    audioRef.current.play().then(() => {
                                        console.log('Auto-play started (mp3)');
                                    }).catch(e => {
                                        console.error('Auto audio play error (mp3):', e);
                                        setError('Auto-play failed. Click "Play Audio" or use fallback player.');
                                        fallbackAudioRef.current.style.display = 'block';
                                        fallbackAudioRef.current.src = data.audioUrl;
                                    });
                                });
                            }
                        }
                    } else {
                        console.warn('No reply in response');
                        setError('No response from Amaia');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    setError(error.message);
                    const errorMessage = {
                        id: Date.now() + 1,
                        sender: 'amaia',
                        text: 'Sorry, I had trouble hearing that. Try again?',
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };
                    setCallTranscript(prev => {
                        console.log('Adding error transcript:', errorMessage);
                        return [...prev, errorMessage];
                    });
                } finally {
                    setIsThinking(false);
                }
            };

            const startListening = () => {
                if (recognitionRef.current && !isRecording) {
                    console.log('Starting speech recognition');
                    recognitionRef.current.start();
                }
            };

            const stopListening = () => {
                if (recognitionRef.current && isRecording) {
                    console.log('Stopping speech recognition');
                    recognitionRef.current.stop();
                }
            };

            const startCall = () => {
                setIsOnCall(true);
                setCurrentPage('call');
                const welcomeMessage = {
                    id: 0,
                    sender: 'amaia',
                    text: "Hey, I'm so glad you called. Talk to me.",
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                setCallTranscript([welcomeMessage]);
                console.log('Call started, transcript initialized:', welcomeMessage);
            };

            const endCall = () => {
                setIsOnCall(false);
                setCurrentPage('intro');
                setCallTranscript([]);
                setLastAudioUrl(null);
                stopListening();
                setError(null);
                console.log('Call ended');
            };

            // INTRO PAGE
            if (currentPage === 'intro') {
                return (
                    <div style={{ minHeight: '100vh', background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, opacity: 0.2 }}>
                            <div style={{ position: 'absolute', top: '80px', left: '40px', width: '384px', height: '384px', background: '#ec4899', borderRadius: '9999px', filter: 'blur(80px)' }} className="animate-pulse" />
                            <div style={{ position: 'absolute', bottom: '80px', right: '40px', width: '320px', height: '320px', background: '#a855f7', borderRadius: '9999px', filter: 'blur(80px)', animationDelay: '1s' }} className="animate-pulse" />
                        </div>

                        <div style={{ position: 'relative', zIndex: 10, maxWidth: '448px', padding: '24px', display: 'flex', flexDirection: 'column', gap: '32px', textAlign: 'center' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                                <div style={{ width: '96px', height: '96px', margin: '0 auto', borderRadius: '9999px', background: 'linear-gradient(135deg, #ec4899, #a855f7)', boxShadow: '0 0 50px rgba(236, 72, 153, 0.5)' }} className="animate-pulse" />
                                <div>
                                    <h1 style={{ fontSize: '48px', fontWeight: 300, letterSpacing: '0.1em', marginBottom: '8px' }}>Amaia</h1>
                                    <p style={{ color: '#9ca3af', fontSize: '14px' }}>is calling...</p>
                                </div>
                            </div>

                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                                <div style={{ width: '8px', height: '8px', background: '#4ade80', borderRadius: '9999px' }} className="animate-pulse" />
                                <p style={{ fontSize: '12px', color: '#9ca3af' }}>live voice chat</p>
                            </div>

                            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center' }}>
                                <button onClick={startCall} style={{ padding: '16px 48px', background: '#16a34a', color: '#fff', border: 'none', borderRadius: '9999px', fontWeight: '600', cursor: 'pointer', fontSize: '16px', boxShadow: '0 0 20px rgba(22, 163, 74, 0.5)' }}>
                                    üìû Answer
                                </button>
                            </div>

                            <p style={{ fontSize: '12px', color: '#4b5563', marginTop: '32px' }}>
                                Welcome to Amaia's world. Real voice conversation.
                            </p>
                            {error && <p style={{ color: '#dc2626', fontSize: '14px', fontWeight: 500 }}>{error}</p>}
                        </div>
                    </div>
                );
            }

            // CALL PAGE
            if (currentPage === 'call') {
                return (
                    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #030712, #000)', color: '#fff', display: 'flex', flexDirection: 'column' }}>
                        <div style={{ position: 'sticky', top: 0, zIndex: 40, background: 'rgba(0, 0, 0, 0.8)', backdropFilter: 'blur(12px)', borderBottom: '1px solid #1f2937' }}>
                            <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '0 16px', height: '64px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <div style={{ textAlign: 'center', flex: 1 }}>
                                    <h2 style={{ fontWeight: 600 }}>Amaia</h2>
                                    <p style={{ fontSize: '12px', color: '#4ade80' }}>on call</p>
                                </div>
                                <button onClick={() => setMuted(!muted)} style={{ background: 'none', border: 'none', color: '#9ca3af', cursor: 'pointer', marginRight: '16px', fontSize: '20px' }}>
                                    {muted ? 'üîá' : 'üîä'}
                                </button>
                                <button onClick={endCall} style={{ background: '#dc2626', border: 'none', borderRadius: '9999px', padding: '12px', color: '#fff', cursor: 'pointer', fontSize: '20px' }}>
                                    üìû
                                </button>
                            </div>
                        </div>

                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '32px 16px', gap: '48px' }}>
                            <div style={{ position: 'relative' }}>
                                <div style={{ width: '128px', height: '128px', borderRadius: '9999px', background: 'linear-gradient(135deg, #ec4899, #a855f7)', boxShadow: '0 0 50px rgba(236, 72, 153, 0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '32px' }} className={isRecording ? 'animate-pulse' : isThinking ? 'animate-bounce' : ''}>
                                    üé§
                                </div>
                                {isThinking && (
                                    <div style={{ position: 'absolute', inset: 0, borderRadius: '9999px', border: '4px solid #ec4899' }} className="animate-pulse" />
                                )}
                            </div>

                            <div style={{ textAlign: 'center' }}>
                                {isRecording && <p style={{ color: '#f472b6', fontSize: '14px', fontWeight: 500 }} className="animate-pulse">Listening...</p>}
                                {isThinking && <p style={{ color: '#c084fc', fontSize: '14px', fontWeight: 500 }} className="animate-pulse">Amaia is thinking...</p>}
                                {!isRecording && !isThinking && <p style={{ color: '#9ca3af', fontSize: '14px' }}>Ready to listen</p>}
                                {error && <p style={{ color: '#dc2626', fontSize: '14px', fontWeight: 500 }}>{error}</p>}
                            </div>

                            {callTranscript.length > 1 && (
                                <div style={{ maxWidth: '448px', display: 'flex', flexDirection: 'column', gap: '12px', maxHeight: '128px', overflowY: 'auto' }}>
                                    {callTranscript.slice(-2).map(msg => (
                                        <div key={msg.id} style={{ fontSize: '14px', color: msg.sender === 'user' ? '#fda4af' : '#d1d5db' }}>
                                            <p style={{ fontSize: '12px', color: '#4b5563', marginBottom: '4px' }}>{msg.sender === 'user' ? 'You' : 'Amaia'}</p>
                                            <p style={{ fontStyle: 'italic' }}>{msg.text}</p>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '16px' }}>
                                <button
                                    onClick={isRecording ? stopListening : startListening}
                                    disabled={isThinking}
                                    style={{
                                        position: 'relative',
                                        width: '80px',
                                        height: '80px',
                                        borderRadius: '9999px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transform: isRecording ? 'scale(1.1)' : 'scale(1)',
                                        background: isRecording ? '#dc2626' : '#ec4899',
                                        border: 'none',
                                        color: '#fff',
                                        fontSize: '28px',
                                        cursor: isThinking ? 'not-allowed' : 'pointer',
                                        opacity: isThinking ? 0.5 : 1,
                                        boxShadow: isRecording ? '0 0 20px rgba(220, 38, 38, 0.5)' : '0 0 20px rgba(236, 72, 153, 0.5)'
                                    }}
                                >
                                    {isRecording ? 'üéôÔ∏è' : 'üé§'}
                                </button>
                                <button
                                    onClick={() => {
                                        console.log('Play Audio button clicked (wrapper)');
                                        playAudio();
                                    }}
                                    disabled={!lastAudioUrl || isThinking}
                                    style={{
                                        padding: '16px 32px',
                                        background: lastAudioUrl && !isThinking ? '#16a34a' : '#4b5563',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '9999px',
                                        fontWeight: '600',
                                        cursor: lastAudioUrl && !isThinking ? 'pointer' : 'not-allowed',
                                        fontSize: '14px',
                                        boxShadow: lastAudioUrl && !isThinking ? '0 0 20px rgba(22, 163, 74, 0.5)' : 'none'
                                    }}
                                >
                                    ‚ñ∂Ô∏è Play Audio
                                </button>
                                <button
                                    onClick={downloadAudio}
                                    disabled={!lastAudioUrl}
                                    style={{
                                        padding: '16px 32px',
                                        background: lastAudioUrl ? '#0284c7' : '#4b5563',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '9999px',
                                        fontWeight: '600',
                                        cursor: lastAudioUrl ? 'pointer' : 'not-allowed',
                                        fontSize: '14px',
                                        boxShadow: lastAudioUrl ? '0 0 20px rgba(2, 132, 199, 0.5)' : 'none'
                                    }}
                                >
                                    ‚¨áÔ∏è Download Audio
                                </button>
                            </div>
                        </div>

                        <div style={{ background: 'rgba(0, 0, 0, 0.5)', borderTop: '1px solid #1f2937', padding: '24px 16px', maxHeight: '192px', overflowY: 'auto' }}>
                            <p style={{ fontSize: '12px', color: '#4b5563', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '16px' }}>Call History</p>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {callTranscript.map(msg => (
                                    <div key={msg.id} style={{ fontSize: '12px', color: msg.sender === 'user' ? '#fda4af' : '#9ca3af' }}>
                                        <p style={{ fontWeight: 600, marginBottom: '4px' }}>{msg.sender === 'user' ? 'You' : 'Amaia'}</p>
                                        <p style={{ lineHeight: 1.5 }}>{msg.text}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }
        }

        ReactDOM.render(<AmaiaPlatform />, document.getElementById('root'));
    </script>
</body>
</html>
