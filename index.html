<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amaia - AI Voice Chat</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function AmaiaPlatform() {
            const [currentPage, setCurrentPage] = useState('intro');
            const [isOnCall, setIsOnCall] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [isThinking, setIsThinking] = useState(false);
            const [muted, setMuted] = useState(false);
            const [callTranscript, setCallTranscript] = useState([]);
            const [error, setError] = useState(null);
            const [audioAllowed, setAudioAllowed] = useState(false);
            const [lastAudioUrl, setLastAudioUrl] = useState(null);
            const recognitionRef = useRef(null);
            const audioRef = useRef(null);

            // Initialize speech recognition
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onstart = () => {
                        console.log('Speech recognition started');
                        setIsRecording(true);
                    };
                    recognitionRef.current.onend = () => {
                        console.log('Speech recognition ended');
                        setIsRecording(false);
                    };
                    recognitionRef.current.onresult = (event) => {
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                handleUserSpeech(event.results[i][0].transcript);
                            }
                        }
                    };
                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech error:', event.error);
                        setIsRecording(false);
                        setError('Microphone error: ' + event.error);
                    };
                } else {
                    console.error('Speech Recognition not supported');
                    setError('Speech Recognition not supported in this browser');
                }
            }, []);

            // Initialize audio context
            useEffect(() => {
                audioRef.current = new Audio();
                const unlockAudio = () => {
                    const audio = new Audio();
                    audio.play().then(() => {
                        console.log('Audio context unlocked');
                        setAudioAllowed(true);
                    }).catch(e => {
                        console.error('Audio unlock error:', e);
                        setError('Please allow audio playback in your browser settings');
                    });
                    document.removeEventListener('click', unlockAudio);
                };
                document.addEventListener('click', unlockAudio);
                return () => document.removeEventListener('click', unlockAudio);
            }, []);

            const playAudio = () => {
                if (lastAudioUrl && audioAllowed && !muted) {
                    console.log('Manually playing audio:', lastAudioUrl);
                    audioRef.current.src = lastAudioUrl;
                    audioRef.current.play().catch(e => {
                        console.error('Manual audio play error:', e);
                        setError('Failed to play audio. Please allow audio in browser settings.');
                    });
                } else if (!audioAllowed) {
                    setError('Audio playback is blocked. Click anywhere to enable audio.');
                } else if (!lastAudioUrl) {
                    setError('No audio available to play.');
                }
            };

            const handleUserSpeech = async (transcript) => {
                if (!transcript.trim()) return;

                console.log('User speech transcribed:', transcript);

                const userMessage = {
                    id: Date.now(),
                    sender: 'user',
                    text: transcript,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                setCallTranscript(prev => {
                    console.log('Adding user transcript:', userMessage);
                    return [...prev, userMessage];
                });

                setIsThinking(true);
                setError(null);

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: transcript })
                    });

                    console.log('Response status:', response.status);
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status} - ${responseText}`);
                    }

                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        throw new Error('Invalid response format from server');
                    }

                    console.log('Backend response:', data);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.reply) {
                        const amaiaMessage = {
                            id: Date.now() + 1,
                            sender: 'amaia',
                            text: data.reply,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        };
                        setCallTranscript(prev => {
                            console.log('Adding Amaia transcript:', amaiaMessage);
                            return [...prev, amaiaMessage];
                        });

                        if (data.audioUrl) {
                            setLastAudioUrl(data.audioUrl);
                            if (!muted && audioAllowed) {
                                console.log('Attempting to play audio:', data.audioUrl);
                                audioRef.current.src = data.audioUrl;
                                audioRef.current.play().catch(e => {
                                    console.error('Auto audio play error:', e);
                                    setError('Auto-play failed. Click "Play Audio" to hear Amaia.');
                                });
                            }
                        }
                    } else {
                        console.warn('No reply in response');
                        setError('No response from Amaia');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    setError(error.message);
