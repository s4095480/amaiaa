<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amaia - AI Voice Chat</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container { max-width: 448px; padding: 24px; text-align: center; }
    .avatar {
      width: 128px;
      height: 128px;
      border-radius: 9999px;
      background: linear-gradient(135deg, #ec4899, #a855f7);
      box-shadow: 0 0 50px rgba(236, 72, 153, 0.5);
      margin: 0 auto 20px;
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    button {
      background: #ec4899;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 9999px;
      cursor: pointer;
      font-weight: 600;
      transition: background 200ms;
    }
    button:hover { background: #f472b6; }
    .status { font-size: 14px; margin: 20px 0; color: #9ca3af; }
    .transcript { background: rgba(0, 0, 0, 0.5); padding: 16px; border-radius: 8px; max-height: 192px; overflow-y: auto; }
    .hidden { display: none; }
    .mic-btn.recording { background: #dc2626; }
    .mic-btn.recording:hover { background: #b91c1c; }
    .modal { background: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function AmaiaPlatform() {
      const [isCallActive, setIsCallActive] = useState(false);
      const [isConnected, setIsConnected] = useState(false);
      const [status, setStatus] = useState('Amaia is online');
      const [transcript, setTranscript] = useState([]);
      const [isMuted, setIsMuted] = useState(false);
      const [showModal, setShowModal] = useState(!localStorage.getItem('elevenLabsKey'));
      const websocketRef = useRef(null);
      const mediaRecorderRef = useRef(null);
      const audioContext = useRef(new AudioContext());
      const audioQueue = useRef([]);
      const isPlaying = useRef(false);

      const addToTranscript = (speaker, text) => {
        setTranscript(prev => [...prev, `${speaker}: ${text}`]);
      };

      const playAudioQueue = () => {
        if (isPlaying.current || audioQueue.current.length === 0) return;
        isPlaying.current = true;
        const chunk = audioQueue.current.shift();
        audioContext.current.decodeAudioData(chunk, (buffer) => {
          const source = audioContext.current.createBufferSource();
          source.buffer = buffer;
          source.connect(audioContext.current.destination);
          source.start();
          source.onended = () => {
            isPlaying.current = false;
            playAudioQueue();
          };
        }, (err) => {
          console.error('Audio decode error:', err);
          isPlaying.current = false;
          playAudioQueue();
        });
      };

      const getSignedUrl = async () => {
        try {
          console.log('Fetching signed URL...');
          const response = await fetch('/.netlify/functions/agent?get-signed-url', { method: 'GET' });
          const data = await response.json();
          console.log('Signed URL response:', data);
          if (!response.ok) throw new Error(data.error || 'Failed to get signed URL');
          return data.signed_url;
        } catch (error) {
          console.error('Signed URL error:', error);
          setStatus('Error connecting to Amaia');
          return null;
        }
      };

      const startConversation = async () => {
        setIsCallActive(true);
        setStatus('Connecting...');

        const signedUrl = await getSignedUrl();
        if (!signedUrl) return;

        console.log('Connecting to WebSocket:', signedUrl);
        websocketRef.current = new WebSocket(signedUrl);

        websocketRef.current.onopen = () => {
          setIsConnected(true);
          setStatus('Connected! Say something...');
          console.log('WebSocket connected');
          websocketRef.current.send(JSON.stringify({ type: 'conversation_initiation_client_data' }));
          if (!isMuted) {
            const welcomeMsg = "Hey, I'm so glad you called. Talk to me.";
            addToTranscript('Amaia', welcomeMsg);
            generateVoice(welcomeMsg);
          }
        };

        websocketRef.current.onmessage = (event) => {
          if (typeof event.data === 'string') {
            try {
              const data = JSON.parse(event.data);
              console.log('Received JSON:', data);
              if (data.type === 'agent_text') {
                addToTranscript('Amaia', data.text || 'Thinking...');
                if (!isMuted) generateVoice(data.text);
              } else if (data.type === 'transcript') {
                addToTranscript('You', data.text);
              }
            } catch (err) {
              console.log('Received text:', event.data);
            }
          } else if (event.data instanceof Blob) {
            event.data.arrayBuffer().then((buffer) => {
              audioQueue.current.push(buffer);
              playAudioQueue();
            }).catch(err => console.error('Audio buffer error:', err));
          }
        };

        websocketRef.current.onerror = (err) => {
          console.error('WebSocket error:', err);
          setStatus('Connection error');
        };

        websocketRef.current.onclose = () => {
          setIsConnected(false);
          setStatus('Disconnected');
          console.log('WebSocket closed');
        };
      };

      const generateVoice = async (text) => {
        try {
          const response = await fetch('/.netlify/functions/agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'voice', text })
          });
          if (!response.ok) throw new Error('Voice generation failed');
          const audioBase64 = await response.text();
          const audioBuffer = Uint8Array.from(atob(audioBase64), c => c.charCodeAt(0)).buffer;
          audioQueue.current.push(audioBuffer);
          playAudioQueue();
        } catch (error) {
          console.error('Voice generation error:', error);
        }
      };

      const startRecording = async () => {
        if (!isConnected || isMuted) return;
        setStatus('Listening...');

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
          mediaRecorderRef.current.ondataavailable = (event) => {
            if (event.data.size > 0 && websocketRef.current.readyState === WebSocket.OPEN) {
              websocketRef.current.send(event.data);
            }
          };
          mediaRecorderRef.current.start(250);
        } catch (err) {
          console.error('Mic error:', err);
          setStatus('Microphone permission denied');
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
          mediaRecorderRef.current.stop();
          mediaRecorderRef.current = null;
        }
        setStatus('Amaia is responding...');
      };

      const hangUp = () => {
        if (websocketRef.current) websocketRef.current.close();
        setIsCallActive(false);
        setTranscript([]);
      };

      const saveApiKey = () => {
        const key = document.getElementById('api-key-input').value;
        localStorage.setItem('elevenLabsKey', key);
        setShowModal(false);
      };

      useEffect(() => {
        return () => {
          if (websocketRef.current) websocketRef.current.close();
        };
      }, []);

      return (
        <div className="container">
          <div style={{ display: isCallActive ? 'none' : 'block' }}>
            <h1 style={{ fontSize: '48px', fontWeight: 300, letterSpacing: '0.1em' }}>Amaia</h1>
            <p style={{ color: '#9ca3af', fontSize: '14px' }}>is calling...</p>
            <div className="avatar"></div>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <div style={{ width: '8px', height: '8px', background: '#4ade80', borderRadius: '9999px', animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite' }} />
              <p style={{ fontSize: '12px', color: '#9ca3af' }}>live voice call</p>
            </div>
            <button onClick={startConversation}>üìû Answer</button>
          </div>
          <div style={{ display: isCallActive ? 'block' : 'none' }}>
            <div className="avatar"></div>
            <div className="status">{status}</div>
            <button
              className={mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive' ? 'mic-btn recording' : 'mic-btn'}
              onClick={mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive' ? stopRecording : startRecording}
            >
              {mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive' ? 'üéôÔ∏è' : 'üé§'}
            </button>
            <button onClick={hangUp}>Hang Up</button>
            <button onClick={() => setIsMuted(!isMuted)}>{isMuted ? 'Unmute' : 'Mute'}</button>
            <div className="transcript">
              {transcript.map((msg, i) => <p key={i}>{msg}</p>)}
            </div>
          </div>
          <div className="modal" style={{ display: showModal ? 'block' : 'none' }}>
            <p>Enter ElevenLabs API Key:</p>
            <input id="api-key-input" type="text" />
            <button onClick={saveApiKey}>Save</button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AmaiaPlatform />, document.getElementById('root'));
  </script>
</body>
</html>
